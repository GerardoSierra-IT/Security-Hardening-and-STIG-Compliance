
<#
.SYNOPSIS
    This PowerShell script ensures that users cannot save passwords in Remote Desktop Client, preventing cached credentials that could be reused by attackers

.NOTES
    Author          : Gerardo Sierra
    GitHub          : github.com/
    Date Created    : 06-14-2025
    Last Modified   : 06-14-2025
    Version         : 1.0
    CVEs            : N/A
    Plugin IDs      : N/A
    STIG-ID         : WN10-AC-000030

.TESTED ON
    Date(s) Tested  : 
    Tested By       : 
    Systems Tested  : 
    PowerShell Ver. : 

.USAGE
    Put any usage instructions here.
    Example syntax:

#>

# YOUR CODE GOES HERE

# WN10-AC-000030: Ensure Minimum Password Age is at least 1 day

# Function to get the current MinimumPasswordAge setting
function Get-MinimumPasswordAge {
    try {
        $minAge = (Get-LocalUser | Select-Object -First 1 | Get-LocalUser).PasswordMinimumAge
        return $minAge.Days
    } catch {
        Write-Warning "Unable to retrieve Minimum Password Age from Local Security Policy."
        return $null
    }
}

# Function to set the MinimumPasswordAge
function Set-MinimumPasswordAge {
    param (
        [int]$MinimumAgeInDays = 1
    )

    try {
        secedit /export /cfg "$env:TEMP\secpol.cfg" | Out-Null

        # Read config
        $config = Get-Content "$env:TEMP\secpol.cfg"

        # Check if policy is already in file
        if ($config -match 'MinimumPasswordAge') {
            $config = $config -replace 'MinimumPasswordAge\s*=\s*\d+', "MinimumPasswordAge = $MinimumAgeInDays"
        } else {
            # Add it under [System Access] if not found
            $index = ($config | Select-String '^\[System Access\]' -SimpleMatch).LineNumber
            if ($index -ne $null) {
                $config = $config[0..($index)] + "MinimumPasswordAge = $MinimumAgeInDays" + $config[($index + 1)..($config.Length - 1)]
            } else {
                Write-Error "Failed to locate [System Access] section in security config."
                return
            }
        }

        # Save updated config
        $config | Set-Content "$env:TEMP\secpol.cfg" -Encoding Unicode

        # Apply changes
        secedit /configure /db secedit.sdb /cfg "$env:TEMP\secpol.cfg" /areas SECURITYPOLICY | Out-Null
        Write-Host "Minimum Password Age successfully set to $MinimumAgeInDays day(s)."
    } catch {
        Write-Error "Failed to set Minimum Password Age: $_"
    }
}

# Main logic
$currentAge = Get-MinimumPasswordAge
if ($currentAge -ne $null) {
    if ($currentAge -lt 1) {
        Write-Host "Minimum Password Age is currently $currentAge day(s). Remediating..."
        Set-MinimumPasswordAge -MinimumAgeInDays 1
    } else {
        Write-Host "Minimum Password Age is already $currentAge day(s). No action needed."
    }
} else {
    Write-Warning "Unable to determine current setting. Attempting to enforce policy..."
    Set-MinimumPasswordAge -MinimumAgeInDays 1
}
